# Ask To Database
该项目基于 [Vanna](https://github.com/vanna-ai/vanna) 进行开发。
项目的主要功能是通过自然语言与数据库进行交互，并输出自动生成的 SQL 语句以及查询的结果。

该项目需要读取数据库表内容。

## 使用方法
该项目的使用必须要以下两个步骤:
1. 训练
![train](./train.png)
使用 Train Flow 来训练模型，需要用户指定一个目录用于存放训练数据，并指定数据库连接信息，尽可能详细地填写数据库描述。
训练数据会给之后的查询提供上下文，以便生成更准确的 SQL 语句。
如果数据库的表本身带有注释最好。

训练只需要执行一次，数据在生成后可以反复使用，因此我们将训练和提问步骤分开进行。如果需要删除所有训练数据，可以直接清空训练数据存放目录。

2. 提问
![ask](./ask.png)
使用 Ask Flow 来提问，需要用户指定数据库连接信息和训练数据目录，并输入自然语言问题。然后会得到自动生成的 SQL 语句以及查询的结果。
如果没有训练数据，那么提问的时候可能因为上下文不足导致无法生成 SQL。

如果发现生成的 SQL 语句不正确，可以尝试：
1. 增加训练数据并重新训练
2. 上调 `n_result_ddl` 参数，增加生成 SQL 时引用的训练数据数量，此举可能会增加 token 的消耗。

## 项目结构
### Flow
#### Train
根据用户输入的 mysql 连接，读取数据库的表结构和用户输入的表描述，并将其存储到向量数据库中。
用户输入的表描述越详细，对后续的自然语言查询越有帮助。尽可能详细地描述表结构和字段，如果数据库表本身有注释，效果更好。
训练可以重复运行，只会更新现有的数据，如果训练内容不变，重复运行不会有任何影响。

如果需要删除所有训练数据，可以直接清空训练数据存放目录。

#### Ask
根据训练的结果，使用大模型生成 SQL 语句并运行，然后返回查询结果和 SQL 并预览。
如果在训练过程中的信息不够明确或者不够详细，可能会导致生成的 SQL 语句不准确或者直接抛出错误。

用户可以指定生成 SQL 的过程中关联的训练数据条数，默认是 10 条，数量越大，生成的 SQL 语句越准确，但也会增加 token 的消耗。

如果查询成功，那么会将查询的结果和 SQL 语句作为训练数据存入向量数据库中，以便后续的查询。

#### Delete training data
用户根据 id 来删除训练数据。

### Shared Block
#### train_by_mysql
用户指定训练数据存放的目录，同时输入 mysql 连接数据和数据库描述，将数据库的表结构和用户输入的表描述存储到向量数据库中。

#### ask_to_database
用户指定训练数据存放的目录，同时输入 mysql 连接数据和用户的自然语言查询，生成 SQL 语句并运行，然后返回查询结果和 SQL 并预览。

#### delete_training_data
用户指定训练数据存放的目录，然后根据 id 来删除训练数据。